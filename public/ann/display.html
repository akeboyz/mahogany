<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Announce ‚Üí Video Loop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body{height:100%;margin:0;background:#000}
    iframe,video{position:absolute;inset:0;width:100%;height:100%;border:0;background:#000}
    #unlock{
      position:fixed;right:16px;bottom:16px;z-index:10;
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;
      font:600 16px system-ui;background:#1a73e8;color:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.3);
    }
  </style>
</head>
<body>

  <!-- A) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® -->
  <iframe id="ann" allow="autoplay; fullscreen"></iframe>

  <!-- B) ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ A) -->
  <video id="clip" playsinline preload="metadata" style="display:none"></video>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠) -->
  <button id="unlock">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>

  <script>
    /*** ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠ 1‚Äì2 ***/
    // [1] ‡∏≠‡πà‡∏≤‡∏ô project_id ‡∏à‡∏≤‡∏Å URL (‡πÄ‡∏ä‡πà‡∏ô /ann/display.html?project_id=prj004)
    const qs = new URLSearchParams(location.search);
    const projectId = qs.get('project_id') || 'prj001';

    // [2] ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å ‡∏ä‡∏µ‡πâ‡∏ó‡∏µ‡πà /ann/announce.html
    const ANNOUNCE_URL   = `/ann/announce.html?project_id=${encodeURIComponent(projectId)}`;

    /*** ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ***/
    const ANNOUNCE_MAX_MS= 45_000;       // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏ö‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ï‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ video ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ
    const VIDEO_SRC      = 'unit001-01.mp4'; // ‡πÉ‡∏™‡πà‡∏û‡∏≤‡∏ò‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    /***************************/

    const ifr  = document.getElementById('ann');
    const clip = document.getElementById('clip');
    const btn  = document.getElementById('unlock');

    let unlocked = false;   // ‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ï‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    let waiting  = null;    // timer ‡∏Ñ‡∏≠‡∏¢‡∏ï‡∏±‡∏î‡∏à‡∏≤‡∏Å announce ‚Üí video
    let listening = false;  // ‡∏Å‡∏±‡∏ô addEventListener ‡∏ã‡πâ‡∏≥

    // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• (‡∏ó‡∏±‡πâ‡∏á iframe ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)
    function unlockAudioOnce(){
      if (unlocked) return;
      unlocked = true;
      btn.style.display = 'none';

      // ‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ announce ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á
      try { ifr.contentWindow?.postMessage({ type: 'UNLOCK_AUDIO' }, '*'); } catch(_) {}

      // prime video: ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ ‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏¢‡∏≠‡∏°
      try {
        clip.src = VIDEO_SRC;
        clip.muted = true;
        clip.play().then(() => { clip.pause(); clip.currentTime = 0; });
      } catch(_) {}
    }
    btn.addEventListener('click', unlockAudioOnce);
    window.addEventListener('pointerdown', unlockAudioOnce, { once:true });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö: ‡πÄ‡∏•‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
    function startAnnounce(){
      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° iframe ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡πâ‡∏≤‡∏á
      ifr.style.display = 'block';
      clip.style.display = 'none';
      clip.pause();

      // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà
      ifr.src = 'about:blank';
      setTimeout(() => { ifr.src = ANNOUNCE_URL; }, 50);

      // ‡∏ü‡∏±‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏ö‡∏£‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
      if (!listening) {
        listening = true;
        window.addEventListener('message', (ev) => {
          if (ev?.data?.type === 'ANNOUNCE_CYCLE_DONE') {
            switchToVideo();
          }
        });
      }

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏à‡∏ö ‡πÉ‡∏´‡πâ fallback ‡∏ï‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ video ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
      clearTimeout(waiting);
      waiting = setTimeout(switchToVideo, ANNOUNCE_MAX_MS);
    }

    // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÅ‡∏•‡∏∞ ‚Äú‡∏õ‡∏¥‡∏î‚Äù ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ä‡∏±‡∏ß‡∏£‡πå ‡πÜ)
    function switchToVideo(){
      clearTimeout(waiting);

      // 1) ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ announce ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
      try { ifr.contentWindow?.postMessage({ type: 'STOP_AUDIO' }, '*'); } catch(_) {}
      // 2) ‡∏ï‡∏±‡∏î‡πÑ‡∏ü‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å cross-origin
      setTimeout(() => { ifr.src = 'about:blank'; }, 100);

      // ‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
      ifr.style.display = 'none';
      clip.style.display = 'block';

      // ‡∏ï‡∏±‡πâ‡∏á src ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ prime ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô)
      if (!clip.src) clip.src = VIDEO_SRC;

      // ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ï‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß
      clip.muted = !unlocked;

      clip.play().catch(()=>{});
    }

    // ‡∏à‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö
    clip.addEventListener('ended', startAnnounce);

    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏•‡∏¢
    startAnnounce();
  </script>
</body>
</html>