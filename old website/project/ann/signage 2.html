<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Signage Player</title>
  <meta name="color-scheme" content="dark light"/>

  <style>
    :root{ --cta-bg: rgba(200,200,200,.35); --cta-border: rgba(255,255,255,.45); --cta-text: #fff; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{background:#000;color:#fff;overflow:hidden;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif}

    .safe-viewport{position:fixed; inset:0; display:grid; place-items:center; background:#000;}
    .frame{position:relative; aspect-ratio:9/16; width:min(100vw, calc(100vh * (9/16))); height:auto; max-height:100vh; background:#000; overflow:hidden;}
    .stage{position:absolute; inset:0; background:#000}
    video,img,iframe{position:absolute; inset:0; width:100%; height:100%; background:#000}
    video,img{object-fit:contain}
    iframe{border:0}

    #status{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#ddd;font-weight:700;text-align:center;z-index:20;padding:10px 14px;border-radius:10px;background:rgba(0,0,0,.35);display:none}
    #status.show{display:block}

    #mainCta{position:absolute; left:0; right:0; bottom:0; display:flex; justify-content:flex-end; align-items:flex-end; z-index:60; padding-right:14px; padding-bottom:14px;}
    #mainCtaBar{margin:0; padding:10px 16px; border-radius:14px; backdrop-filter:blur(4px); background:var(--cta-bg); border:1px solid var(--cta-border); color:var(--cta-text); font-weight:800; display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none}

    #headCta{position:absolute; top:0; left:0; right:0; display:flex; justify-content:flex-start; z-index:70; padding-top:14px; padding-left:14px;}
    #floatCta{margin:0; padding:9px 14px; border-radius:999px; color:var(--cta-text);font-weight:800; background:var(--cta-bg);border:1px solid var(--cta-border); box-shadow:0 8px 24px rgba(0,0,0,.28); display:none;align-items:center;gap:8px;cursor:pointer;user-select:none; max-width:min(72%,520px); max-inline-size:min(72%,520px); white-space:normal; overflow-wrap:anywhere; hyphens:auto; text-wrap:balance; font-size:clamp(12px,1.8vw,16px); line-height:1.15; transform-origin: top right;}

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
    #unlock{
      position:fixed;right:16px;top:16px;z-index:80;
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;
      font:600 15px system-ui;background:#1a73e8;color:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,.32);display:none;
    }

    #ver{position:fixed;left:12px;bottom:12px;z-index:80;font-size:12px;color:#9aa5b1;opacity:.7;user-select:none}
  </style>
</head>
<body>

  <div class="safe-viewport">
    <div class="frame" id="frameBox">
      <div class="stage" aria-live="polite">
        <!-- A) ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠/‡∏£‡∏π‡∏õ -->
        <video id="v" playsinline preload="metadata" muted></video>
        <img id="img" alt=""/>

        <!-- B) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡πÉ‡∏ä‡πâ iframe ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏ó‡∏™‡∏ï‡πå) -->
        <iframe id="ann" allow="autoplay; fullscreen" style="display:none"></iframe>

        <!-- C) URL ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô playlist) -->
        <iframe id="web" allow="autoplay; fullscreen" style="display:none"></iframe>
      </div>

      <div id="mainCta">
        <div id="mainCtaBar" title="Main Menu"><span> ‚Ü©Ô∏è main menu</span></div>
      </div>

      <div id="headCta">
        <div id="floatCta" role="button" tabindex="0" title="More details">
          <span>üëÜüèªfor more details/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
        </div>
      </div>
    </div>
  </div>

  <div id="status"></div>
  <div id="ver"></div>
  <button id="unlock">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<!-- üîä ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <audio id="bgm" preload="auto" playsinline></audio>
  <script>
    (function bgmLoop(){
      const audio  = document.getElementById('bgm');
      window.elBgm = audio; // üëà ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ playItem(video) ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô

      const tracks = [1,2,3,4,5].map(n => `/ann/music/bg-music${String(n).padStart(3,'0')}.mp3`);
      let i = 0;

      audio.volume = 0.6;
      audio.loop = false;

      function playCurrent(){
        audio.src = tracks[i];
        const p = audio.play();
        if (p && p.catch) {
          const unlock = () => { audio.play().catch(()=>{}); window.removeEventListener('pointerdown', unlock); };
          window.addEventListener('pointerdown', unlock, { once:true });
        }
      }

      audio.addEventListener('ended', () => { i = (i+1) % tracks.length; playCurrent(); });
      audio.addEventListener('error', () => { i = (i+1) % tracks.length; playCurrent(); });

      document.addEventListener('DOMContentLoaded', playCurrent);

      // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏° method ‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î video ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
      audio.nextTrack = () => {
        i = (i+1) % tracks.length;
        playCurrent();
      };
    })();
  </script>

  <script>
  (function(){
    const IMG_DURATION_SEC = 10;
    const URL_DURATION_SEC = 20;
    const ANNOUNCE_SECONDS = 5;    // max wait ‡∏ñ‡πâ‡∏≤ iframe ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì
    const VERSION_POLL_MS = 60_000;

    const qs = new URLSearchParams(location.search);
    const projectId = qs.get('project_id') || 'prj001';

    // ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô /ann ‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ï‡πâ ann/data/*
    const playlistPath = `/ann/data/playlist.json`;
    const mediasPath   = `/ann/data/medias.json`;

    const elV   = document.getElementById('v');
    const elImg = document.getElementById('img');
    const ifrAnn= document.getElementById('ann');
    const elWeb = document.getElementById('web');
    const elStat= document.getElementById('status');
    const elVer = document.getElementById('ver');
    const frameBox=document.getElementById('frameBox');

    const mainCtaBar=document.getElementById('mainCtaBar');
    const floatCta=document.getElementById('floatCta');
    const unlockBtn=document.getElementById('unlock');

    function isHttpUrl(s){return typeof s==='string' && /^https?:\/\//i.test(s)}
    function extOf(p){const m=(p||'').match(/\.([a-z0-9]+)(?:[?#]|$)/i);return m?m[1].toLowerCase():''}
    function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
    const todayISO=()=>new Date().toISOString().slice(0,10);

    function isiOSSafari(){
      const ua=navigator.userAgent;
      const isiOS=/iPad|iPhone|iPod/.test(ua);
      const isSafari=/^((?!chrome|android).)*safari/i.test(ua);
      return isiOS || isSafari;
    }

    function withinDateRange(m){
      const t=todayISO();
      const s=m.start_date||null, e=m.end_date||null;
      if(s && t<s) return false;
      if(e && t>e) return false;
      return true;
    }

    function showStatus(msg){elStat.textContent=msg;elStat.classList.add('show')}
    function hideStatus(){elStat.classList.remove('show')}

    function hideAll(){
      // media elements
      elV.pause(); elV.removeAttribute('src'); elV.load(); elV.style.display='none';
      elImg.removeAttribute('src'); elImg.style.display='none';
      elWeb.src='about:blank'; elWeb.style.display='none';
      ifrAnn.src='about:blank'; ifrAnn.style.display='none';
    }

function buildMainMenuUrl(pid){
  const u = new URL('/ann/menu.html', location.origin);
  u.searchParams.set('project_id', pid);
  return u.toString();
}

    function buildDetailUrl(meta){
      if(!meta) return null;
      const ref=(meta.id_ref||'').toLowerCase();
      if(!ref) return null;
      let type='';
      if(ref.startsWith('unit')) type='unit';
      else if(ref.startsWith('shop')) type='shop';
      else if(ref.startsWith('rest')) type='rest';
      else if(ref.startsWith('market')) type='market';
      else if(ref.startsWith('food')) type='food';
      else return null;
      const id=encodeURIComponent(meta.id_ref);
      switch(type){
        case 'unit':   return `/unit.html?id=${id}`;
        case 'shop':   return `/shop.html?id=${id}`;
        case 'rest':   return `/rest.html?rest=${id}`;
        case 'market': return `/marketplace.html?id=${id}`;
        case 'food':   return `/foodie.html?id=${id}`;
        default:       return null;
      }
    }

    // ‚úÖ ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢ ‚Äú‡∏ó‡∏≥‡∏û‡∏≤‡∏ò‡∏™‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î‡∏£‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏°‡∏≠‚Äù
    function resolveMediaSrc(s){
      if(!s) return s;
      if (/^https?:\/\//i.test(s) || s.startsWith('/')) return s; // absolute ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      const rootPath = '/' + s.replace(/^(\.\/)+/, '').replace(/^ann\//, '');
      return new URL(rootPath, location.origin).toString();
    }

    async function loadJson(path){
      const res=await fetch(path,{cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status} @ ${path}`);
      return res.json();
    }

    function updateCtaPositions(kind){
      const pad = 14;
      const fw = frameBox.clientWidth, fh = frameBox.clientHeight;

      let ar = 9/16;
      if(kind==='video' && elV.videoWidth && elV.videoHeight){
        ar = elV.videoWidth / elV.videoHeight;
      }else if(kind==='image' && elImg.naturalWidth && elImg.naturalHeight){
        ar = elImg.naturalWidth / elImg.naturalHeight;
      }else{ // iframe kinds
        document.getElementById('headCta').style.top   = pad + 'px';
        document.getElementById('headCta').style.left  = pad + 'px';
        document.getElementById('mainCta').style.right = pad + 'px';
        document.getElementById('mainCta').style.bottom= pad + 'px';
        return;
      }

      let cw, ch;
      if (fw/fh > ar){ ch = fh; cw = Math.round(fh * ar); }
      else { cw = fw; ch = Math.round(fw / ar); }
      const offX = Math.round((fw - cw)/2);
      const offY = Math.round((fh - ch)/2);

      document.getElementById('headCta').style.top    = (offY + pad) + 'px';
      document.getElementById('headCta').style.left   = (offX + pad) + 'px';
      document.getElementById('mainCta').style.right  = (offX + pad) + 'px';
      document.getElementById('mainCta').style.bottom = (offY + pad) + 'px';
    }

    // ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏•‡πà‡∏ô: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (iframe) ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å ----------
    async function buildSequence(pid){
      const [allPlaylists,medias]=await Promise.all([loadJson(playlistPath),loadJson(mediasPath)]);
      const pl=allPlaylists?.playlists?.[pid]||{items:[],loop:true};
      const ids=(pl.items||[]).map(x=>x.media_id);
      const list=Array.isArray(medias?.medias)?medias.medias:[];
      const byId=new Map(list.map(m=>[m.media_id,m]));
      const out=[];

      // 1) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ö‡∏ö iframe (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á style/‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
      const annUrl = new URL('announce.html', location.href);
      annUrl.searchParams.set('project_id', pid);
      out.push({
        kind:'announce-iframe',
        src: annUrl.toString(),
        duration: ANNOUNCE_SECONDS,
        meta:{ id_ref:`announce:${pid}`, detail_url: annUrl.toString() }
      });

      // 2) ‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏û‡∏•‡∏¢‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå
      for(const id of ids){
        const m=byId.get(id);
        if(!m) continue;
        const approved=(m.approval_status||'').toLowerCase()==='approved';
        const inDate=withinDateRange(m);
        const inProject=Array.isArray(m.project_ids)?m.project_ids.includes(pid):true;
        if(!approved||!inDate||!inProject) continue;

        let kind='video',src=m.file_name,duration=0;
        const ext=extOf(m.file_name);
        if(m.media_type==='image' || ['jpg','jpeg','png','gif','webp'].includes(ext)){
          kind='image'; duration=IMG_DURATION_SEC;
        }else if(m.media_type==='url' || isHttpUrl(m.file_name)){
          kind='url'; duration=URL_DURATION_SEC;
        }else{
          kind='video';
        }

        // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô root-relative ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô /ann/ ‡∏Å‡∏•‡∏∑‡∏ô‡∏û‡∏≤‡∏ò
        src = resolveMediaSrc(src);

        out.push({kind,src,duration,meta:m});
      }

      const loop=pl?.loop!==false;
      return {sequence:out,loop};
    }

    function setupMainCta(){
      const url=buildMainMenuUrl(projectId);
      const go=()=>location.href=url;
      mainCtaBar.onclick=go;
      mainCtaBar.onkeydown=e=>{if(e.key==='Enter'||e.key===' ') go()};
    }

    function showHeadFor(meta){
      const url=(meta && meta.detail_url) || buildDetailUrl(meta);
      if(!url){floatCta.style.display='none';return;}
      const go=()=>location.href=url;
      floatCta.onclick=go;
      floatCta.onkeydown=e=>{if(e.key==='Enter'||e.key===' ') go()};
      floatCta.style.display='flex';
    }

    const lastKey=`signage:lastIndex:${projectId}`;
    let sequence=[],loopPlay=true,index=0;

    async function playAll(){
      hideStatus();
      if(sequence.length===0){showStatus('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ');return;}
      const saved=parseInt(sessionStorage.getItem(lastKey)||'0',10);
      index=(!isNaN(saved)&&saved>=0&&saved<sequence.length)?saved:0;
      while(true){
        const item=sequence[index];
        sessionStorage.setItem(lastKey,String(index));
        try{await playItem(item);}catch(e){ console.error(e); }
        index++;
        if(index>=sequence.length){ if(!loopPlay) break; index=0; }
      }
    }

    async function playItem(item){
      hideAll();
      showHeadFor(item.meta);
      updateCtaPositions(item.kind);
      // ‡∏ã‡πà‡∏≠‡∏ô CTA signage ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
document.getElementById('mainCta').style.display = 'none';
document.getElementById('headCta').style.display = 'none';

if (item.kind === 'video') {
  elV.src = item.src;
  // ‡πÅ‡∏™‡∏î‡∏á CTA signage ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡πÑ‡∏õ /ann/menu.html (by project)
const url = buildMainMenuUrl(projectId);   // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
const go  = () => location.href = url;
document.getElementById('mainCta').style.display = '';     // ‡πÇ‡∏ä‡∏ß‡πå CTA ‡∏´‡∏•‡∏±‡∏Å
document.getElementById('headCta').style.display = 'none'; // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
mainCtaBar.onclick   = go;
mainCtaBar.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') go(); };
  elV.loop = false;
  elV.style.display = 'block';

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö muted ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ autoplay ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
  elV.muted = true;
  elV.onloadedmetadata = () => updateCtaPositions('video');

  // ===== BGM helpers =====
  const elBgm = window.elBgm;
  const bgmPause  = () => { try { if (elBgm && !elBgm.paused) elBgm.pause(); } catch(_){} };
  const bgmResume = () => { try { if (elBgm && elBgm.paused) elBgm.play().catch(()=>{}); } catch(_){} };
  const bgmNext   = () => { try { if (elBgm && typeof elBgm.nextTrack === 'function') elBgm.nextTrack(); } catch(_){} };

  // ‚õî ‡∏´‡∏¢‡∏∏‡∏î BGM "‡∏ó‡∏±‡∏ô‡∏ó‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏¥‡∏õ
  bgmPause();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏ó‡∏£‡πá‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏ô‡∏à‡∏¥‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)
  function hasAudioNow(v){
    try {
      if ('audioTracks' in v && v.audioTracks && v.audioTracks.length > 0) return true;       // Safari/Edge (‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô)
      if (typeof v.mozHasAudio === 'boolean') return v.mozHasAudio;                            // Firefox
      if (typeof v.webkitAudioDecodedByteCount === 'number') return v.webkitAudioDecodedByteCount > 0; // WebKit
    } catch(_) {}
    return false;
  }

  // ‡∏£‡∏≠ metadata ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ duration ‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡πÑ‡∏õ‡∏ï‡πà‡∏≠)
  const metaReady = new Promise(res => {
    if (!isFinite(elV.duration) || elV.duration === 0) {
      elV.addEventListener('loadedmetadata', () => res(), { once: true });
    } else { res(); }
  });
  await Promise.race([metaReady, sleep(2000)]);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏¢‡∏±‡∏á muted)
  try { await elV.play(); } catch (_) {}

  // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á:
  // - ‡∏ñ‡πâ‡∏≤‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏°‡∏≤‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (unmute) ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ BGM ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏ï‡πà‡∏≠
  // - ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î BGM ‡∏Å‡∏•‡∏±‡∏ö
  let usingVideoAudio = false;
  if (hasAudioNow(elV)) {
    usingVideoAudio = true;
    elV.muted = false;
  } else {
    // ‡∏£‡∏≠‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏π‡πà ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πâ‡∏≤
    await sleep(600);
    if (hasAudioNow(elV)) {
      usingVideoAudio = true;
      elV.muted = false;
    } else {
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‚Üí ‡πÉ‡∏´‡πâ BGM ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ñ‡∏•‡∏≠
      bgmResume();
    }
  }

  // ‡∏£‡∏≠‡∏à‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏à‡∏ö/‡πÄ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏≠‡∏£‡πå/‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (fallback 30s + 1s buffer)
  await new Promise(resolve => {
    const sec = (isFinite(elV.duration) && elV.duration > 0) ? elV.duration : 30;
    const watchdog = setTimeout(() => {
      if (usingVideoAudio) bgmNext();  // ‡∏à‡∏ö‡∏Ñ‡∏•‡∏¥‡∏õ‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‚Üí ‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏ó‡∏£‡πá‡∏Å‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      resolve();
    }, Math.ceil(sec + 1) * 1000);

    elV.onended = () => { clearTimeout(watchdog); if (usingVideoAudio) bgmNext(); resolve(); };
    elV.onerror = () => { clearTimeout(watchdog); if (usingVideoAudio) bgmNext(); resolve(); };
  });

  floatCta.style.display = 'none';
}
else if(item.kind==='image'){
        elImg.onload=()=>updateCtaPositions('image');
        elImg.src=item.src; elImg.style.display='block';
        await sleep((item.duration||IMG_DURATION_SEC)*1000);
        floatCta.style.display='none';
}else if(item.kind==='announce-iframe'){
  // üëâ ‡∏ã‡πà‡∏≠‡∏ô CTA ‡∏Ç‡∏≠‡∏á signage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ó‡∏ô)
  document.getElementById('mainCta').style.display = 'none';
  document.getElementById('headCta').style.display = 'none';

  const elBgm = window.elBgm;
  const bgmPause = () => { try{ if(elBgm && !elBgm.paused) elBgm.pause(); }catch(_){} };
  const bgmResume = () => { try{ if(elBgm && elBgm.paused) elBgm.play().catch(()=>{}); }catch(_){} };

  floatCta.style.display='none';
  const src=item.src;
  let timer=null, resolved=false;
  const finish=()=>{ if(!resolved){ resolved=true; clearTimeout(timer); } };
  const onMsg=(ev)=>{
    if(ev?.data?.type==='ANNOUNCE_CYCLE_DONE'){ 
      finish(); 
      next(); 
      bgmResume();
    }
    if(ev?.data?.type==='REQUEST_UNLOCK_BTN'){ unlockBtn.style.display='block'; }
  };
  function next(){ window.removeEventListener('message', onMsg); }
  window.addEventListener('message', onMsg);

  timer=setTimeout(()=>{ finish(); next(); bgmResume(); }, (item.duration||ANNOUNCE_SECONDS)*1000);

  bgmPause();
  ifrAnn.style.display='block';
  ifrAnn.src='about:blank';
  setTimeout(()=>{ ifrAnn.src=src; }, 30);

  await new Promise(resolve=>{
    const poll=setInterval(()=>{
      if(resolved){ clearInterval(poll); resolve(); }
    }, 200);
  });

  try { ifrAnn.contentWindow?.postMessage({type:'STOP_AUDIO'}, '*'); } catch(_) {}
  setTimeout(()=>{ ifrAnn.src='about:blank'; }, 50);

}

else if(item.kind==='url'){
        floatCta.style.display='none';
        const watchdog = setTimeout(()=>{ try{elWeb.src='about:blank';}catch{} }, Math.max((item.duration||URL_DURATION_SEC),5)*1000 + 3000);
        await new Promise(resolve=>{
          const done=()=>{ clearTimeout(watchdog); resolve(); };
          elWeb.onload = ()=>{ setTimeout(done, (item.duration||URL_DURATION_SEC)*1000); };
          elWeb.onerror= ()=>{ showStatus('‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); setTimeout(done, 1500); };
          elWeb.src=item.src; elWeb.style.display='block'; updateCtaPositions('url');
        });
      }
    }

    function setupUnlock(){
      if(!isiOSSafari()) return;
      unlockBtn.style.display='block';
      const once=()=>{
        unlockBtn.style.display='none';
        try{ ifrAnn.contentWindow?.postMessage({type:'UNLOCK_AUDIO'}, '*'); }catch(_){}
        try{ elV.muted=true; elV.play().then(()=>{ elV.pause(); elV.currentTime=0; }); }catch(_){}
      };
      unlockBtn.addEventListener('click', once, {once:true});
      window.addEventListener('pointerdown', once, {once:true});
    }

    (function pollVersion(){
      let cur='';
      async function tick(){
        try{
          const r=await fetch('/version.txt',{cache:'no-store'});
          if(r.ok){
            const t=(await r.text()).trim();
            if(cur && t && t!==cur) location.reload();
            cur=t; elVer.textContent=t?`v ${t}`:'';
          }
        }catch(e){}
      }
      tick(); setInterval(tick, VERSION_POLL_MS);
    })();

    function init(){
      setupMainCta();
      setupUnlock();
      buildSequence(projectId).then(({sequence:seq,loop})=>{
        sequence=seq; loopPlay=loop;
        playAll();
      }).catch(e=>{
        console.error(e); showStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      });
    }

    addEventListener('resize', ()=>updateCtaPositions('video'));
    addEventListener('keydown',e=>{ if(['ArrowUp','ArrowDown',' '].includes(e.key)) e.preventDefault(); });

    init();
  })();
  </script>
  
</body>
</html>