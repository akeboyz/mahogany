<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects Overview</title>
  <style>
    /* ===== Theme ให้เหมือน ann/index.html ===== */
    :root { --maxw: 980px; --ui-font: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif; }
    body { font-family: var(--ui-font); margin: 0; background: #f7f9fc; color:#1b1f24; }
    header { max-width: var(--maxw); margin: 24px auto 0; padding: 0 16px; }
    h1 { margin: 0 0 6px; font-size: 1.6rem; }
    .sub { color:#586069; margin-bottom: 16px; }

    /* Toolbar ให้เหมือนกัน (grid, ปุ่ม/ช่องกรอง) */
    .toolbar { max-width: var(--maxw); margin: 8px auto; padding: 8px 16px; display: grid; gap: 8px;
               grid-template-columns: 1fr 260px; align-items: center; }
    .toolbar input[type="search"], .toolbar select {
      padding: 8px 10px; border: 1px solid #d0d7de; border-radius: 8px; background: #fff; font: inherit;
    }

    /* กล่องสถิติ (เผื่ออนาคต; ไม่จำเป็นต้องแสดงค่าตอนนี้) */
    .stats { max-width: var(--maxw); margin: 8px auto; padding: 0 16px 8px; display: grid; gap: 8px; grid-template-columns: repeat(3, 1fr); }
    .stat { background:#fff; border:1px solid #e6eef6; border-radius:12px; padding:12px; box-shadow: 0 2px 16px #00000008;}
    .stat .k { font-size: 0.9rem; color:#51606f; }
    .stat .v { font-size: 1.3rem; font-weight: 700; color:#0b57d0; }

    /* ตาราง + กล่องครอบเหมือนในหน้า ann */
    .table-wrap { max-width: var(--maxw); margin: 8px auto 24px; padding: 0 16px; }
    table { width: 100%; border-collapse: collapse; background:#fff; border:1px solid #e6eef6; border-radius: 12px;
            overflow: hidden; box-shadow: 0 2px 16px #00000008; }
    thead th { background: #f1f6ff; color:#0b57d0; text-align: left; font-weight: 600; padding: 12px; font-size: 0.95rem; user-select: none; }
    tbody td { padding: 10px 12px; border-top:1px solid #f0f3f7; vertical-align: middle; }
    tbody tr:hover { background:#fafcff; }

    /* ลิงก์ในตารางให้สีเดียวกับหน้า ann */
    .table-wrap a.link { color:#0b57d0; text-decoration: underline; }
    .table-wrap a.link:visited { color:#0b57d0; }
    .table-wrap a.link:hover { text-decoration: underline; }

    /* คอลัมน์ตัวเลขให้ดูเด่นเล็กน้อย */
    .num a.link, .num .nolink { font-weight:700; }
    .nolink { color:#000; text-decoration:none; }

    /* โลโก้โปรเจกต์ */
    .logo-cell { width:44px }
    .logo { width:28px; height:28px; border-radius:6px; object-fit:cover; background:#d1d5db; border:1px solid #e6eef6; }

    /* กล่องว่าง/เออเรอร์ ให้โทนเดียวกับ ann */
    .status, .empty, .error { max-width: var(--maxw); margin: 8px auto 0; padding: 0 16px; color:#6a737d; }
    .empty, .error { padding: 16px; border:1px dashed #e6eef6; border-radius:12px; background:#fff; }

    @media (max-width: 900px){
      .toolbar { grid-template-columns: 1fr; }
      thead { display: none; }
      table, tbody, tr, td { display: block; width: 100%; }
      tbody tr { border-top:1px solid #eef2f7; }
      tbody td { border: none; padding: 8px 12px; }
      tbody td::before { content: attr(data-col) ": "; font-weight: 600; color:#6b7280; }
      .logo-cell { display:none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ภาพรวมโครงการ (Projects Overview)</h1>
    <div class="sub">รูปแบบตัวอักษร/สี/พื้นหลัง และสไตล์ตาราง ถูกปรับให้เหมือนกับหน้า Announcements เพื่อความคงเส้นคงวา</div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <input id="search" type="search" placeholder="ค้นหาโครงการ..." aria-label="ค้นหาโครงการ" />
    <select id="sort" aria-label="จัดเรียง">
      <option value="name">Sort: ชื่อ (A→Z)</option>
      <option value="units">Sort: จำนวนยูนิต</option>
      <option value="foodies">Sort: จำนวน Foodies</option>
      <option value="markets">Sort: จำนวน Marketplace</option>
      <option value="announces">Sort: จำนวน Announcements</option>
    </select>
  </div>

  <!-- ตาราง -->
  <div class="table-wrap">
    <div id="status" class="status" aria-live="polite"></div>
    <table aria-label="Projects table">
      <thead>
        <tr>
          <th>Logo</th>
          <th>Project ID</th>
          <th>Project name</th>
          <th>PM</th>
          <th>No. of listed units</th>
          <th>No. of foodies</th>
          <th>No. of marketplace</th>
          <th>No. of announcement</th>
        </tr>
      </thead>
      <tbody id="result"></tbody>
    </table>
  </div>

  <div id="empty" class="empty" style="display:none">ยังไม่มีโครงการในระบบ</div>
  <div id="error" class="error" style="display:none">โหลดข้อมูลไม่สำเร็จ บางส่วนอาจไม่แสดง</div>

  <script>
    /* ---------- DATA CONFIG ---------- */
    const DATA_PATHS = {
      projects: 'ann/data/project.json',
      pms:      'ann/data/pm.json',
      units:    'ann/data/unit.json',
      foodies:  'ann/data/foodie.json',
      markets:  'ann/data/market.json',
      announces:'ann/data/announce.json'
    };

    /* ---------- HELPERS ---------- */
    const $ = sel => document.querySelector(sel);
    const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
    async function loadJSON(path){ const res = await fetch(path,{cache:'no-store'}); if(!res.ok) throw new Error(`HTTP ${res.status} @ ${path}`); return res.json(); }
    function groupBy(arr, key){ const map=new Map(); (arr||[]).forEach(i=>{const k=i?.[key]; if(!k) return; if(!map.has(k)) map.set(k,[]); map.get(k).push(i);}); return map; }

    /* ---------- NORMALIZE ---------- */
    function normalizeMaps({projects, pms, units, foodies, markets, announces}){
      const projList = Array.isArray(projects?.projects) ? projects.projects : [];
      const pmList = Array.isArray(pms?.property_management_companies) ? pms.property_management_companies : [];
      const pmById = new Map(pmList.map(pm => [pm.pm_id, pm]));
      const unitsByProject   = groupBy(Array.isArray(units?.units) ? units.units : [], 'project_id');
      const foodByProject    = groupBy(Array.isArray(foodies?.foodies) ? foodies.foodies : [], 'project_id');
      const marketByProject  = groupBy(Array.isArray(markets?.markets) ? markets.markets : [], 'project_id');
      const annArr = Array.isArray(announces) ? announces : (
        Array.isArray(announces?.announcements) ? announces.announcements :
        Array.isArray(announces?.announce) ? announces.announce : []
      );
      const annByProject = groupBy(annArr, 'project_id');

      return projList.map(p => {
        const projId = p.project_id;
        const pm = p.pm_id ? pmById.get(p.pm_id) : null;
        const u = unitsByProject.get(projId) || [];
        const f = foodByProject.get(projId) || [];
        const m = marketByProject.get(projId) || [];
        const a = annByProject.get(projId) || [];
        return { project:p, pm, counts:{ units:u.length, foodies:f.length, markets:m.length, announces:a.length } };
      });
    }

    /* ---------- TABLE ROW ---------- */
    function projectRow({project, pm, counts}){
      const tr = el('tr');

      // Logo
      const tdLogo = el('td', {className:'logo-cell', 'data-col':'Logo'});
      if (project.project_logo){
        const img = el('img', {className:'logo', alt:''});
        img.src = project.project_logo;
        tdLogo.appendChild(img);
      } else {
        tdLogo.appendChild(el('span', {className:'nolink', textContent:''}));
      }

      // Project ID (no link)
      const tdId = el('td', {className:'pid nolink', textContent: project.project_id, 'data-col':'Project ID'});

      // Project name → projects.html (relative) — ใช้คลาส link ให้โทนเหมือน ann
      const tdName = el('td', {className:'pname', 'data-col':'Project name'});
      const nameLink = el('a', {
        className:'link',
        href:`projects.html?project_id=${encodeURIComponent(project.project_id)}`,
        textContent: project.project_name || project.project_id
      });
      tdName.appendChild(nameLink);

      // PM (ลิงก์ถ้ามี ไม่งั้นแสดงดำ)
      const tdPM = el('td', {className:'pm', 'data-col':'PM'});
      if (pm){
        const pmName = pm.name_th || pm.name_en || pm.pm_id;
        const a = el('a', {className:'link', href:`pm.html?pm_id=${encodeURIComponent(pm.pm_id)}`, textContent: pmName});
        tdPM.appendChild(a);
      }else{
        tdPM.appendChild(el('span', {className:'nolink', textContent:'ไม่ระบุ'}));
      }

      // ตัวเลข (ลิงก์ = น้ำเงิน, ไม่มีลิงก์ = ดำ)
      const tdUnits = countCell(counts.units,     `unit.html?project_id=${encodeURIComponent(project.project_id)}`,     'No. of listed units');
      const tdFood  = countCell(counts.foodies,   `foodie.html?project_id=${encodeURIComponent(project.project_id)}`,   'No. of foodies');
      const tdMkt   = countCell(counts.markets,   `marketplace.html?project_id=${encodeURIComponent(project.project_id)}`,'No. of marketplace');
      const tdAnn   = countCell(counts.announces, `ann/index.html?project_id=${encodeURIComponent(project.project_id)}`,'No. of announcement');

      tr.append(tdLogo, tdId, tdName, tdPM, tdUnits, tdFood, tdMkt, tdAnn);
      return tr;
    }

    function countCell(num, href, label){
      const td = el('td', {className:'num', 'data-col':label});
      if (Number(num) > 0 && href){
        td.appendChild(el('a', {className:'link', href, textContent:String(num)}));
      }else{
        td.appendChild(el('span', {className:'nolink', textContent:String(num)}));
      }
      return td;
    }

    /* ---------- APP ---------- */
    (async function init(){
      try{
        const [projects, pms, units, foodies, markets, announces] = await Promise.all([
          loadJSON(DATA_PATHS.projects), loadJSON(DATA_PATHS.pms),
          safeLoad(DATA_PATHS.units), safeLoad(DATA_PATHS.foodies),
          safeLoad(DATA_PATHS.markets), loadJSON(DATA_PATHS.announces)
        ]);
        let data = normalizeMaps({projects, pms, units, foodies, markets, announces});
        render(data);

        $('#search').addEventListener('input', () => render(filterAndSort(data)));
        $('#sort').addEventListener('change', () => render(filterAndSort(data)));

        function filterAndSort(list){
          const q = ($('#search').value || '').trim().toLowerCase();
          const mode = $('#sort').value;
          let out = list.filter(item=>{
            const name = (item.project.project_name || '').toLowerCase();
            const pid = (item.project.project_id || '').toLowerCase();
            return !q || name.includes(q) || pid.includes(q);
          });
          out.sort((a,b)=>{
            if(mode==='name'){
              const an = (a.project.project_name || '').toLowerCase();
              const bn = (b.project.project_name || '').toLowerCase();
              return an.localeCompare(bn);
            }
            if(mode==='units')     return b.counts.units     - a.counts.units;
            if(mode==='foodies')   return b.counts.foodies   - a.counts.foodies;
            if(mode==='markets')   return b.counts.markets   - a.counts.markets;
            if(mode==='announces') return b.counts.announces - a.counts.announces;
            return 0;
          });
          return out;
        }
      }catch(err){
        console.error(err);
        $('#error').style.display='';
      }
    })();

    async function safeLoad(path){ try { return await loadJSON(path); } catch(e){ return {}; } }

    function render(items){
      const tbody = $('#result'); tbody.innerHTML = '';
      if(!items || !items.length){ $('#empty').style.display = ''; return; }
      $('#empty').style.display = 'none';
      items.forEach(it => tbody.appendChild(projectRow(it)));
    }
  </script>
</body>
</html>