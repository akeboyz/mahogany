<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width:100vw; height:100vh; background:black; overflow:hidden;
      font-family:sans-serif; display:flex; flex-direction:column; align-items:center;
    }
    .page-wrapper{
      aspect-ratio:9 / 16; width:100%; height:100vh; max-width:56.25vh;
      display:flex; flex-direction:column; background:white;
    }
    .banner-container{
      position:relative; width:100%; aspect-ratio:9 / 5; overflow:hidden;
      background: linear-gradient(45deg, #007bff, #0056b3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      font-weight: bold;
    }
    .banner-container video{ width:100%; height:100%; object-fit:cover; display:block; background:black; }
    .back-to-menu{
      position:absolute; bottom:10px; right:10px; z-index:80;
      margin:0; padding:5px 10px; border:1px solid rgba(255,255,255,0.1); border-radius:13px;
      background:rgba(0,0,0,0.15); backdrop-filter:blur(8px); box-shadow:none;
      color:#fff; font-weight:600; font-size:15px; letter-spacing:0.3px; text-shadow:0 2px 8px rgba(0,0,0,0.8);
      display:flex; align-items:center; gap:5px; cursor:pointer; user-select:none;
      transition:all 0.3s ease;
    }
    .back-to-menu::before{
      content:"☰";
      font-size:13px;
      font-weight:400;
    }
    .back-to-menu:hover{
      background:rgba(0,0,0,0.25);
      border-color:rgba(255,255,255,0.2);
      transform:translateY(-2px);
    }
    .blink{
      animation:blink 1.2s ease-in-out infinite;
    }
    @keyframes blink{
      0%,100%{opacity:1}
      50%{opacity:0.35}
    }
    .shop-grid{
      flex:1; display:grid; grid-template-columns:repeat(4,1fr); grid-auto-rows:1fr;
      gap:6px; padding:10px; overflow-y:auto; width:100%; background:white;
    }
    .shop-card{
      background:#333; border-radius:8px; overflow:hidden; display:flex; flex-direction:column;
      align-items:center; text-align:center; color:white; font-size:12px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .shop-card:hover {
      transform: scale(1.05);
    }
    .shop-card img{ width:100%; height:70%; object-fit:cover; display:block; }
    .shop-card .shop-name{ padding:8px; flex:1; display:flex; align-items:center; }
    .shop-card.empty{ background:#ddd; border:1px dashed #aaa; cursor:default; }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 1rem;
      color: #666;
    }
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-size: 12px;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }
    .filter-select {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 11px;
      background: white;
      min-width: 80px;
      max-width: 120px;
      flex-shrink: 1;
    }
    .filter-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .filter-btn:hover {
      background: #0056b3;
    }
    .filter-label {
      font-size: 10px;
      color: #666;
      margin-right: 4px;
      flex-shrink: 0;
      white-space: nowrap;
    }

    /* Blink animation */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>
  <div class="page-wrapper" style="position: relative;">
    <div class="banner-container">
      <video id="bannerVideo" autoplay muted playsinline preload="metadata" style="display: none;">
        <source id="bannerSrc" src="" type="video/mp4" />
      </video>
      <div id="bannerText">DELIVERY</div>
      <div id="backBtn" class="back-to-menu blink">Menu</div>
    </div>

    <!-- Cart icon removed -->

    <!-- Countdown overlay -->
    <div id="countdownOverlay" style="
      position: absolute;
      top: 10px;
      right: 10px;
      margin: 0;
      padding: 3px 7px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 7px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(4px);
      box-shadow: none;
      color: #fff;
      font-weight: 600;
      font-size: 8px;
      letter-spacing: 0.1px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 35px;
      height: 20px;
      justify-content: center;
      z-index: 100;
      animation: blink 1.2s ease-in-out infinite;
      display: none;
    ">
      Back to Video in&nbsp;<span id="countdownSeconds">60</span>&nbsp;secs
    </div>

    <div class="filter-bar">
      <span class="filter-label">Filter:</span>
      <select id="categoryFilter" class="filter-select">
        <option value="">All Categories</option>
      </select>

      <span class="filter-label">Sort:</span>
      <select id="sortSelect" class="filter-select">
        <option value="name">Name A-Z</option>
        <option value="price-low">Price Low-High</option>
        <option value="price-high">Price High-Low</option>
      </select>

      <button id="clearFilters" class="filter-btn">Clear</button>
    </div>

    <div class="shop-grid" id="shopGrid">
      <div class="loading">Loading items...</div>
    </div>
  </div>

<script>
  console.log('=== SIMPLE CATEGORY PAGE STARTED ===');

  // Get parameters
  const qs = new URLSearchParams(location.search);
  const type = qs.get('type') || 'dining';
  const projectId = qs.get('project_id') || 'prj001';

  console.log('Parameters:', { type, projectId });

  // Update banner text
  const bannerText = document.getElementById('bannerText');
  const titles = {
    'delivery': 'DELIVERY',
    'dining': 'DINING',
    'daily': 'DAILY SERVICES',
    'ondemand': 'ON-DEMAND',
    'deal': 'PROPERTY DEALS',
    'juristic': 'ANNOUNCEMENTS'
  };
  bannerText.textContent = titles[type] || type.toUpperCase();

  // Back button
  document.getElementById('backBtn').onclick = function() {
    console.log('Back button clicked');
    window.location.href = `/menu.html?project_id=${projectId}`;
  };

  // Load banner video
  const video = document.getElementById('bannerVideo');
  const videoSrc = document.getElementById('bannerSrc');
  videoSrc.src = `./medias/${type}.mp4`;

  video.onloadeddata = function() {
    console.log('Video loaded successfully');
    video.style.display = 'block';
    bannerText.style.display = 'none';
  };

  video.onerror = function() {
    console.log('Video failed to load, keeping text banner');
  };

  video.load();

  // Global variables for filtering
  let allItems = [];
  let filteredItems = [];

  // Update sort options based on page type
  function updateSortOptions() {
    const sortSelect = document.getElementById('sortSelect');

    // Clear existing options
    sortSelect.innerHTML = '';

    if (type === 'juristic') {
      // Sort options for announcements
      sortSelect.innerHTML = `
        <option value="name">Name A-Z</option>
        <option value="date-new">Date (Newest First)</option>
        <option value="date-old">Date (Oldest First)</option>
        <option value="priority">Priority (High to Low)</option>
      `;
    } else {
      // Default sort options for other types
      sortSelect.innerHTML = `
        <option value="name">Name A-Z</option>
        <option value="price-low">Price Low-High</option>
        <option value="price-high">Price High-Low</option>
      `;
    }
  }

  // Filter functionality
  function initializeFilters() {
    const categoryFilter = document.getElementById('categoryFilter');
    const sortSelect = document.getElementById('sortSelect');
    const clearFilters = document.getElementById('clearFilters');

    // Update sort options based on type
    updateSortOptions();

    // Populate category filter
    populateCategoryFilter();

    // Filter event listeners
    categoryFilter.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applyFilters);

    // Clear filters
    clearFilters.addEventListener('click', function() {
      categoryFilter.value = '';
      sortSelect.value = 'name';
      applyFilters();
    });
  }

  function populateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    const categories = new Set();

    // Extract unique categories from items
    allItems.forEach(item => {
      if (item.category_th) categories.add(item.category_th);
      if (item.category_en) categories.add(item.category_en);
    });

    // Add categories to dropdown
    Array.from(categories).sort().forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categoryFilter.appendChild(option);
    });
  }

  function applyFilters() {
    const categoryValue = document.getElementById('categoryFilter').value;

    // Start with all items
    filteredItems = [...allItems];

    // Apply category filter
    if (categoryValue) {
      filteredItems = filteredItems.filter(item =>
        item.category_th === categoryValue || item.category_en === categoryValue
      );
    }

    // Apply sorting
    applySortAndRender();
  }

  function applySortAndRender() {
    const sortBy = document.getElementById('sortSelect').value;

    // Sort the filtered items
    switch(sortBy) {
      case 'name':
        filteredItems.sort((a, b) => {
          const nameA = (a.name_th || a.name_en || '').toLowerCase();
          const nameB = (b.name_th || b.name_en || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });
        break;
      case 'price-low':
      case 'price-high':
        filteredItems.sort((a, b) => {
          const priceA = getItemPrice(a) || 0;
          const priceB = getItemPrice(b) || 0;
          return sortBy === 'price-low' ? priceA - priceB : priceB - priceA;
        });
        break;
      case 'date-new':
      case 'date-old':
        filteredItems.sort((a, b) => {
          const dateA = new Date(a.created_date || a.date || '2025-01-01');
          const dateB = new Date(b.created_date || b.date || '2025-01-01');
          return sortBy === 'date-new' ? dateB - dateA : dateA - dateB;
        });
        break;
      case 'priority':
        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
        filteredItems.sort((a, b) => {
          const priorityA = priorityOrder[a.priority] || 2;
          const priorityB = priorityOrder[b.priority] || 2;
          return priorityB - priorityA; // High to low
        });
        break;
    }

    renderItems(filteredItems);
  }

  function getItemPrice(item) {
    if (item.price) return parseFloat(item.price) || 0;
    if (item.condition?.selling_price) return parseFloat(item.condition.selling_price) || 0;
    if (item.condition?.rental_price) return parseFloat(item.condition.rental_price) || 0;
    return 0;
  }

  // Load items
  async function loadItems() {
    const grid = document.getElementById('shopGrid');

    try {
      console.log('Loading items for type:', type);

      let items = [];

      if (type === 'delivery' || type === 'dining') {
        const response = await fetch('./data/rest.json');
        const restaurants = await response.json();
        console.log('Loaded restaurants:', restaurants.length);

        if (type === 'delivery') {
          items = restaurants.filter(item =>
            item.type === 'both' &&
            item.projects && item.projects.includes(projectId) &&
            item.status === 'active'
          );
        } else {
          items = restaurants.filter(item =>
            (item.type === 'dine' || item.type === 'both') &&
            item.projects && item.projects.includes(projectId) &&
            item.status === 'active'
          );
        }
      }
      else if (type === 'daily' || type === 'ondemand') {
        const response = await fetch('./data/shop.json');
        const shops = await response.json();
        console.log('Loaded shops:', shops.length);

        if (type === 'daily') {
          items = shops.filter(item =>
            item.type === 'non-service' &&
            item.projects && item.projects.includes(projectId) &&
            item.status === 'active'
          );
        } else {
          items = shops.filter(item =>
            item.type === 'service' &&
            item.projects && item.projects.includes(projectId) &&
            item.status === 'active'
          );
        }
      }
      else if (type === 'deal') {
        const response = await fetch('./data/unit.json');
        const data = await response.json();
        console.log('Loaded units:', data.units.length);

        items = data.units.filter(item =>
          item.project_id === projectId &&
          (item.condition?.selling_price || item.condition?.rental_price)
        );

        // Transform unit data
        items.forEach(unit => {
          unit.name_th = `${unit.unit?.room_type || 'Unit'} ${unit.unit?.unit_number || ''}`;
          unit.name_en = unit.name_th;
          unit.id = unit.unit_id;
        });
      }
      else if (type === 'juristic') {
        const response = await fetch('./ann/data/announce.json');
        const announcements = await response.json();
        console.log('Loaded announcements:', announcements.length);

        items = announcements.filter(item =>
          String(item.project_id) === String(projectId) &&
          item.status === 'active'
        );

        // Transform announcement data
        items.forEach(announcement => {
          announcement.name_th = announcement.title_th || announcement.title_en || 'ประกาศ';
          announcement.name_en = announcement.title_en || announcement.title_th || 'Announcement';
          announcement.id = announcement.announcement_id;
          // Use announcement image as the card image
          announcement.images = announcement.image ? [announcement.image] : [];
        });
      }

      console.log('Filtered items:', items.length);
      console.log('Sample item:', items[0]);

      // Store items globally for filtering
      allItems = items;
      filteredItems = [...items];

      // Initialize filters
      initializeFilters();

      // Render initial items
      renderItems(filteredItems);

    } catch (error) {
      console.error('Error loading items:', error);
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: red;">Error loading items: ' + error.message + '</div>';
    }
  }

  // Render items function (separated for reuse by filters)
  function renderItems(items) {
    const grid = document.getElementById('shopGrid');

    // Clear grid
    grid.innerHTML = '';

    if (items.length === 0) {
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">No items found</div>';
      return;
    }

    let count = 0;

    // Render actual items
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-card';

        const name = item.name_th || item.name_en || item.id || 'Unknown';
        let imageSrc = './medias/placeholder.jpg';

        if (item.images && item.images.length > 0) {
          // For announcements, images path already includes ann/
          if (type === 'juristic' && item.images[0].startsWith('images/')) {
            imageSrc = './ann/' + item.images[0];
          } else {
            imageSrc = './' + item.images[0];
          }
        } else if (item.logo) {
          imageSrc = './' + item.logo;
        }

        div.innerHTML = `
          <img src="${imageSrc}" alt="${name}" onerror="this.src='./medias/placeholder.jpg'">
          <div class="shop-name">${name}</div>
        `;

        // Add click handler
        div.onclick = function() {
          console.log('Item clicked:', item.id);

          if (type === 'daily' || type === 'ondemand') {
            window.location.href = `./shop-signage.html?shop=${item.id}&project_id=${projectId}`;
          } else if (type === 'delivery' || type === 'dining') {
            window.location.href = `./rest-signage.html?rest=${item.id}&project_id=${projectId}`;
          } else if (type === 'deal') {
            window.location.href = `./unit-signage.html?id=${item.id}&project_id=${projectId}`;
          } else if (type === 'juristic') {
            openAnnouncementPopup(item);
          }
        };

        grid.appendChild(div);
        count++;
      });

    // Fill empty spaces to always have 12 slots (4x3 grid)
    for (let i = count; i < 12; i++) {
      const div = document.createElement('div');
      div.className = 'shop-card empty';
      grid.appendChild(div);
    }
  }

  // Cart functionality removed

  // Load items immediately
  loadItems();

  // Cart display removed

  // Auto-return to main menu after 60 seconds of inactivity
  let inactivityTimer;
  let countdownInterval;
  let countdownStartTime;
  const RETURN_DELAY = 60000; // 60 seconds
  const COUNTDOWN_SHOW_DELAY = 10000; // Show countdown after 10 seconds

  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    clearInterval(countdownInterval);
    document.getElementById('countdownOverlay').style.display = 'none';

    countdownStartTime = Date.now();

    inactivityTimer = setTimeout(() => {
      // Return to main menu, not signage
      const menuUrl = `./menu.html${projectId ? `?project_id=${projectId}` : ''}`;
      window.location.href = menuUrl;
    }, RETURN_DELAY);

    // Show countdown after 10 seconds
    setTimeout(() => {
      showCountdown();
    }, COUNTDOWN_SHOW_DELAY);
  }

  function showCountdown() {
    const overlay = document.getElementById('countdownOverlay');
    const secondsSpan = document.getElementById('countdownSeconds');

    overlay.style.display = 'flex';

    countdownInterval = setInterval(() => {
      const elapsed = Date.now() - countdownStartTime;
      const remaining = Math.max(0, Math.ceil((RETURN_DELAY - elapsed) / 1000));

      secondsSpan.textContent = remaining;

      if (remaining <= 0) {
        clearInterval(countdownInterval);
        overlay.style.display = 'none';
      }
    }, 1000);
  }

  // Set up inactivity listeners
  ['click', 'touchstart', 'mousemove', 'keydown'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer);
  });

  // Start the timer
  resetInactivityTimer();

  // Get image source (same logic as category cards)
  function getImageSrc(item) {
    let imageSrc = './medias/placeholder.jpg';

    if (item.images && item.images.length > 0) {
      // For announcements, images path already includes ann/
      if (type === 'juristic' && item.images[0].startsWith('images/')) {
        imageSrc = './ann/' + item.images[0];
      } else {
        imageSrc = './' + item.images[0];
      }
    } else if (item.logo) {
      imageSrc = './' + item.logo;
    }

    return imageSrc;
  }

  // Announcement popup function
  function openAnnouncementPopup(item) {
    const popup = document.createElement('div');
    popup.id = 'announcementPopup';
    popup.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    `;

    const countdownTime = 15; // 15 seconds
    let timeLeft = countdownTime;

    popup.innerHTML = `
      <div style="
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
      ">
        <img src="${getImageSrc(item)}"
             style="
               max-width: 100%;
               max-height: 80vh;
               object-fit: contain;
               border-radius: 8px;
               box-shadow: 0 4px 20px rgba(0,0,0,0.5);
             "
             onerror="this.src='./medias/placeholder.jpg'">
        <div id="countdownText" style="
          color: white;
          font-size: 24px;
          font-weight: 600;
          margin-top: 20px;
          text-align: center;
          background: rgba(0,0,0,0.7);
          padding: 10px 20px;
          border-radius: 20px;
        ">
          Auto close in ${timeLeft}s
        </div>
        <button onclick="closeAnnouncementPopup()" style="
          position: absolute;
          top: -10px;
          right: -10px;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: white;
          border: none;
          font-size: 20px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        ">×</button>
      </div>
    `;

    document.body.appendChild(popup);

    // Countdown timer
    const countdownInterval = setInterval(() => {
      timeLeft--;
      const countdownEl = document.getElementById('countdownText');
      if (countdownEl) {
        countdownEl.textContent = `Auto close in ${timeLeft}s`;
      }
      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        closeAnnouncementPopup();
      }
    }, 1000);

    // Store interval for cleanup
    popup.countdownInterval = countdownInterval;

    // Reset inactivity timer
    resetInactivityTimer();
  }

  // Close popup function
  window.closeAnnouncementPopup = function() {
    const popup = document.getElementById('announcementPopup');
    if (popup) {
      if (popup.countdownInterval) {
        clearInterval(popup.countdownInterval);
      }
      popup.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => popup.remove(), 300);
    }
    resetInactivityTimer();
  };

  // Add fade animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  `;
  document.head.appendChild(style);

  console.log('=== SCRIPT LOADED SUCCESSFULLY ===');
</script>
</body>
</html>